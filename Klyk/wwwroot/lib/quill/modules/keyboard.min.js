/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/quill@1.3.7/modules/keyboard.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import clone from"clone";import equal from"deep-equal";import extend from"extend";import Delta from"quill-delta";import DeltaOp from"quill-delta/lib/op";import Parchment from"parchment";import Quill from"../core/quill";import logger from"../core/logger";import Module from"../core/module";let debug=logger("quill:keyboard");const SHORTKEY=/Mac/i.test(navigator.platform)?"metaKey":"ctrlKey";class Keyboard extends Module{static match(e,t){return t=normalize(t),!["altKey","ctrlKey","metaKey","shiftKey"].some(function(l){return!!t[l]!==e[l]&&null!==t[l]})&&t.key===(e.which||e.keyCode)}constructor(e,t){super(e,t),this.bindings={},Object.keys(this.options.bindings).forEach(t=>{("list autofill"!==t||null==e.scroll.whitelist||e.scroll.whitelist.list)&&this.options.bindings[t]&&this.addBinding(this.options.bindings[t])}),this.addBinding({key:Keyboard.keys.ENTER,shiftKey:null},handleEnter),this.addBinding({key:Keyboard.keys.ENTER,metaKey:null,ctrlKey:null,altKey:null},function(){}),/Firefox/i.test(navigator.userAgent)?(this.addBinding({key:Keyboard.keys.BACKSPACE},{collapsed:!0},handleBackspace),this.addBinding({key:Keyboard.keys.DELETE},{collapsed:!0},handleDelete)):(this.addBinding({key:Keyboard.keys.BACKSPACE},{collapsed:!0,prefix:/^.?$/},handleBackspace),this.addBinding({key:Keyboard.keys.DELETE},{collapsed:!0,suffix:/^.?$/},handleDelete)),this.addBinding({key:Keyboard.keys.BACKSPACE},{collapsed:!1},handleDeleteRange),this.addBinding({key:Keyboard.keys.DELETE},{collapsed:!1},handleDeleteRange),this.addBinding({key:Keyboard.keys.BACKSPACE,altKey:null,ctrlKey:null,metaKey:null,shiftKey:null},{collapsed:!0,offset:0},handleBackspace),this.listen()}addBinding(e,t={},l={}){let i=normalize(e);if(null==i||null==i.key)return debug.warn("Attempted to add invalid keyboard binding",i);"function"==typeof t&&(t={handler:t}),"function"==typeof l&&(l={handler:l}),i=extend(i,t,l),this.bindings[i.key]=this.bindings[i.key]||[],this.bindings[i.key].push(i)}listen(){this.quill.root.addEventListener("keydown",e=>{if(e.defaultPrevented)return;let t=e.which||e.keyCode,l=(this.bindings[t]||[]).filter(function(t){return Keyboard.match(e,t)});if(0===l.length)return;let i=this.quill.getSelection();if(null==i||!this.quill.hasFocus())return;let[n,s]=this.quill.getLine(i.index),[r,o]=this.quill.getLeaf(i.index),[a,u]=0===i.length?[r,o]:this.quill.getLeaf(i.index+i.length),d=r instanceof Parchment.Text?r.value().slice(0,o):"",f=a instanceof Parchment.Text?a.value().slice(u):"",c={collapsed:0===i.length,empty:0===i.length&&n.length()<=1,format:this.quill.getFormat(i),offset:s,prefix:d,suffix:f};l.some(e=>{if(null!=e.collapsed&&e.collapsed!==c.collapsed)return!1;if(null!=e.empty&&e.empty!==c.empty)return!1;if(null!=e.offset&&e.offset!==c.offset)return!1;if(Array.isArray(e.format)){if(e.format.every(function(e){return null==c.format[e]}))return!1}else if("object"==typeof e.format&&!Object.keys(e.format).every(function(t){return!0===e.format[t]?null!=c.format[t]:!1===e.format[t]?null==c.format[t]:equal(e.format[t],c.format[t])}))return!1;return!(null!=e.prefix&&!e.prefix.test(c.prefix))&&(!(null!=e.suffix&&!e.suffix.test(c.suffix))&&!0!==e.handler.call(this,i,c))})&&e.preventDefault()})}}function makeEmbedArrowHandler(e,t){const l=e===Keyboard.keys.LEFT?"prefix":"suffix";return{key:e,shiftKey:t,altKey:null,[l]:/^$/,handler:function(l){let i=l.index;e===Keyboard.keys.RIGHT&&(i+=l.length+1);const[n]=this.quill.getLeaf(i);return!(n instanceof Parchment.Embed)||(e===Keyboard.keys.LEFT?t?this.quill.setSelection(l.index-1,l.length+1,Quill.sources.USER):this.quill.setSelection(l.index-1,Quill.sources.USER):t?this.quill.setSelection(l.index,l.length+1,Quill.sources.USER):this.quill.setSelection(l.index+l.length+1,Quill.sources.USER),!1)}}}function handleBackspace(e,t){if(0===e.index||this.quill.getLength()<=1)return;let[l]=this.quill.getLine(e.index),i={};if(0===t.offset){let[t]=this.quill.getLine(e.index-1);if(null!=t&&t.length()>1){let t=l.formats(),n=this.quill.getFormat(e.index-1,1);i=DeltaOp.attributes.diff(t,n)||{}}}let n=/[\uD800-\uDBFF][\uDC00-\uDFFF]$/.test(t.prefix)?2:1;this.quill.deleteText(e.index-n,n,Quill.sources.USER),Object.keys(i).length>0&&this.quill.formatLine(e.index-n,n,i,Quill.sources.USER),this.quill.focus()}function handleDelete(e,t){let l=/^[\uD800-\uDBFF][\uDC00-\uDFFF]/.test(t.suffix)?2:1;if(e.index>=this.quill.getLength()-l)return;let i={},n=0,[s]=this.quill.getLine(e.index);if(t.offset>=s.length()-1){let[t]=this.quill.getLine(e.index+1);if(t){let l=s.formats(),r=this.quill.getFormat(e.index,1);i=DeltaOp.attributes.diff(l,r)||{},n=t.length()}}this.quill.deleteText(e.index,l,Quill.sources.USER),Object.keys(i).length>0&&this.quill.formatLine(e.index+n-1,l,i,Quill.sources.USER)}function handleDeleteRange(e){let t=this.quill.getLines(e),l={};if(t.length>1){let e=t[0].formats(),i=t[t.length-1].formats();l=DeltaOp.attributes.diff(i,e)||{}}this.quill.deleteText(e,Quill.sources.USER),Object.keys(l).length>0&&this.quill.formatLine(e.index,1,l,Quill.sources.USER),this.quill.setSelection(e.index,Quill.sources.SILENT),this.quill.focus()}function handleEnter(e,t){e.length>0&&this.quill.scroll.deleteAt(e.index,e.length);let l=Object.keys(t.format).reduce(function(e,l){return Parchment.query(l,Parchment.Scope.BLOCK)&&!Array.isArray(t.format[l])&&(e[l]=t.format[l]),e},{});this.quill.insertText(e.index,"\n",l,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.focus(),Object.keys(t.format).forEach(e=>{null==l[e]&&(Array.isArray(t.format[e])||"link"!==e&&this.quill.format(e,t.format[e],Quill.sources.USER))})}function makeCodeBlockHandler(e){return{key:Keyboard.keys.TAB,shiftKey:!e,format:{"code-block":!0},handler:function(t){let l=Parchment.query("code-block"),i=t.index,n=t.length,[s,r]=this.quill.scroll.descendant(l,i);if(null==s)return;let o=this.quill.getIndex(s),a=s.newlineIndex(r,!0)+1,u=s.newlineIndex(o+r+n),d=s.domNode.textContent.slice(a,u).split("\n");r=0,d.forEach((t,o)=>{e?(s.insertAt(a+r,l.TAB),r+=l.TAB.length,0===o?i+=l.TAB.length:n+=l.TAB.length):t.startsWith(l.TAB)&&(s.deleteAt(a+r,l.TAB.length),r-=l.TAB.length,0===o?i-=l.TAB.length:n-=l.TAB.length),r+=t.length+1}),this.quill.update(Quill.sources.USER),this.quill.setSelection(i,n,Quill.sources.SILENT)}}}function makeFormatHandler(e){return{key:e[0].toUpperCase(),shortKey:!0,handler:function(t,l){this.quill.format(e,!l.format[e],Quill.sources.USER)}}}function normalize(e){if("string"==typeof e||"number"==typeof e)return normalize({key:e});if("object"==typeof e&&(e=clone(e,!1)),"string"==typeof e.key)if(null!=Keyboard.keys[e.key.toUpperCase()])e.key=Keyboard.keys[e.key.toUpperCase()];else{if(1!==e.key.length)return null;e.key=e.key.toUpperCase().charCodeAt(0)}return e.shortKey&&(e[SHORTKEY]=e.shortKey,delete e.shortKey),e}Keyboard.keys={BACKSPACE:8,TAB:9,ENTER:13,ESCAPE:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,DELETE:46},Keyboard.DEFAULTS={bindings:{bold:makeFormatHandler("bold"),italic:makeFormatHandler("italic"),underline:makeFormatHandler("underline"),indent:{key:Keyboard.keys.TAB,format:["blockquote","indent","list"],handler:function(e,t){if(t.collapsed&&0!==t.offset)return!0;this.quill.format("indent","+1",Quill.sources.USER)}},outdent:{key:Keyboard.keys.TAB,shiftKey:!0,format:["blockquote","indent","list"],handler:function(e,t){if(t.collapsed&&0!==t.offset)return!0;this.quill.format("indent","-1",Quill.sources.USER)}},"outdent backspace":{key:Keyboard.keys.BACKSPACE,collapsed:!0,shiftKey:null,metaKey:null,ctrlKey:null,altKey:null,format:["indent","list"],offset:0,handler:function(e,t){null!=t.format.indent?this.quill.format("indent","-1",Quill.sources.USER):null!=t.format.list&&this.quill.format("list",!1,Quill.sources.USER)}},"indent code-block":makeCodeBlockHandler(!0),"outdent code-block":makeCodeBlockHandler(!1),"remove tab":{key:Keyboard.keys.TAB,shiftKey:!0,collapsed:!0,prefix:/\t$/,handler:function(e){this.quill.deleteText(e.index-1,1,Quill.sources.USER)}},tab:{key:Keyboard.keys.TAB,handler:function(e){this.quill.history.cutoff();let t=(new Delta).retain(e.index).delete(e.length).insert("\t");this.quill.updateContents(t,Quill.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(e.index+1,Quill.sources.SILENT)}},"list empty enter":{key:Keyboard.keys.ENTER,collapsed:!0,format:["list"],empty:!0,handler:function(e,t){this.quill.format("list",!1,Quill.sources.USER),t.format.indent&&this.quill.format("indent",!1,Quill.sources.USER)}},"checklist enter":{key:Keyboard.keys.ENTER,collapsed:!0,format:{list:"checked"},handler:function(e){let[t,l]=this.quill.getLine(e.index),i=extend({},t.formats(),{list:"checked"}),n=(new Delta).retain(e.index).insert("\n",i).retain(t.length()-l-1).retain(1,{list:"unchecked"});this.quill.updateContents(n,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.scrollIntoView()}},"header enter":{key:Keyboard.keys.ENTER,collapsed:!0,format:["header"],suffix:/^$/,handler:function(e,t){let[l,i]=this.quill.getLine(e.index),n=(new Delta).retain(e.index).insert("\n",t.format).retain(l.length()-i-1).retain(1,{header:null});this.quill.updateContents(n,Quill.sources.USER),this.quill.setSelection(e.index+1,Quill.sources.SILENT),this.quill.scrollIntoView()}},"list autofill":{key:" ",collapsed:!0,format:{list:!1},prefix:/^\s*?(\d+\.|-|\*|\[ ?\]|\[x\])$/,handler:function(e,t){let l,i=t.prefix.length,[n,s]=this.quill.getLine(e.index);if(s>i)return!0;switch(t.prefix.trim()){case"[]":case"[ ]":l="unchecked";break;case"[x]":l="checked";break;case"-":case"*":l="bullet";break;default:l="ordered"}this.quill.insertText(e.index," ",Quill.sources.USER),this.quill.history.cutoff();let r=(new Delta).retain(e.index-s).delete(i+1).retain(n.length()-2-s).retain(1,{list:l});this.quill.updateContents(r,Quill.sources.USER),this.quill.history.cutoff(),this.quill.setSelection(e.index-i,Quill.sources.SILENT)}},"code exit":{key:Keyboard.keys.ENTER,collapsed:!0,format:["code-block"],prefix:/\n\n$/,suffix:/^\s+$/,handler:function(e){const[t,l]=this.quill.getLine(e.index),i=(new Delta).retain(e.index+t.length()-l-2).retain(1,{"code-block":null}).delete(1);this.quill.updateContents(i,Quill.sources.USER)}},"embed left":makeEmbedArrowHandler(Keyboard.keys.LEFT,!1),"embed left shift":makeEmbedArrowHandler(Keyboard.keys.LEFT,!0),"embed right":makeEmbedArrowHandler(Keyboard.keys.RIGHT,!1),"embed right shift":makeEmbedArrowHandler(Keyboard.keys.RIGHT,!0)}};export{Keyboard as default,SHORTKEY};
//# sourceMappingURL=/sm/8681fc538d9c53d42cfe2e0343acfc68a6cb24f16b62c869f00b49db9549c0ad.map