/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/quill@1.3.7/modules/clipboard.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import extend from"extend";import Delta from"quill-delta";import Parchment from"parchment";import Quill from"../core/quill";import logger from"../core/logger";import Module from"../core/module";import{AlignAttribute,AlignStyle}from"../formats/align";import{BackgroundStyle}from"../formats/background";import CodeBlock from"../formats/code";import{ColorStyle}from"../formats/color";import{DirectionAttribute,DirectionStyle}from"../formats/direction";import{FontStyle}from"../formats/font";import{SizeStyle}from"../formats/size";let debug=logger("quill:clipboard");const DOM_KEY="__ql-matcher",CLIPBOARD_CONFIG=[[Node.TEXT_NODE,matchText],[Node.TEXT_NODE,matchNewline],["br",matchBreak],[Node.ELEMENT_NODE,matchNewline],[Node.ELEMENT_NODE,matchBlot],[Node.ELEMENT_NODE,matchSpacing],[Node.ELEMENT_NODE,matchAttributor],[Node.ELEMENT_NODE,matchStyles],["li",matchIndent],["b",matchAlias.bind(matchAlias,"bold")],["i",matchAlias.bind(matchAlias,"italic")],["style",matchIgnore]],ATTRIBUTE_ATTRIBUTORS=[AlignAttribute,DirectionAttribute].reduce(function(t,e){return t[e.keyName]=e,t},{}),STYLE_ATTRIBUTORS=[AlignStyle,BackgroundStyle,ColorStyle,DirectionStyle,FontStyle,SizeStyle].reduce(function(t,e){return t[e.keyName]=e,t},{});class Clipboard extends Module{constructor(t,e){super(t,e),this.quill.root.addEventListener("paste",this.onPaste.bind(this)),this.container=this.quill.addContainer("ql-clipboard"),this.container.setAttribute("contenteditable",!0),this.container.setAttribute("tabindex",-1),this.matchers=[],CLIPBOARD_CONFIG.concat(this.options.matchers).forEach(([t,n])=>{(e.matchVisual||n!==matchSpacing)&&this.addMatcher(t,n)})}addMatcher(t,e){this.matchers.push([t,e])}convert(t){if("string"==typeof t)return this.container.innerHTML=t.replace(/\>\r?\n +\</g,"><"),this.convert();const e=this.quill.getFormat(this.quill.selection.savedRange.index);if(e[CodeBlock.blotName]){const t=this.container.innerText;return this.container.innerHTML="",(new Delta).insert(t,{[CodeBlock.blotName]:e[CodeBlock.blotName]})}let[n,i]=this.prepareMatching(),r=traverse(this.container,n,i);return deltaEndsWith(r,"\n")&&null==r.ops[r.ops.length-1].attributes&&(r=r.compose((new Delta).retain(r.length()-1).delete(1))),debug.log("convert",this.container.innerHTML,r),this.container.innerHTML="",r}dangerouslyPasteHTML(t,e,n=Quill.sources.API){if("string"==typeof t)this.quill.setContents(this.convert(t),e),this.quill.setSelection(0,Quill.sources.SILENT);else{let i=this.convert(e);this.quill.updateContents((new Delta).retain(t).concat(i),n),this.quill.setSelection(t+i.length(),Quill.sources.SILENT)}}onPaste(t){if(t.defaultPrevented||!this.quill.isEnabled())return;let e=this.quill.getSelection(),n=(new Delta).retain(e.index),i=this.quill.scrollingContainer.scrollTop;this.container.focus(),this.quill.selection.update(Quill.sources.SILENT),setTimeout(()=>{n=n.concat(this.convert()).delete(e.length),this.quill.updateContents(n,Quill.sources.USER),this.quill.setSelection(n.length()-e.length,Quill.sources.SILENT),this.quill.scrollingContainer.scrollTop=i,this.quill.focus()},1)}prepareMatching(){let t=[],e=[];return this.matchers.forEach(n=>{let[i,r]=n;switch(i){case Node.TEXT_NODE:e.push(r);break;case Node.ELEMENT_NODE:t.push(r);break;default:[].forEach.call(this.container.querySelectorAll(i),t=>{t[DOM_KEY]=t[DOM_KEY]||[],t[DOM_KEY].push(r)})}}),[t,e]}}function applyFormat(t,e,n){return"object"==typeof e?Object.keys(e).reduce(function(t,n){return applyFormat(t,n,e[n])},t):t.reduce(function(t,i){return i.attributes&&i.attributes[e]?t.push(i):t.insert(i.insert,extend({},{[e]:n},i.attributes))},new Delta)}function computeStyle(t){if(t.nodeType!==Node.ELEMENT_NODE)return{};return t["__ql-computed-style"]||(t["__ql-computed-style"]=window.getComputedStyle(t))}function deltaEndsWith(t,e){let n="";for(let i=t.ops.length-1;i>=0&&n.length<e.length;--i){let e=t.ops[i];if("string"!=typeof e.insert)break;n=e.insert+n}return n.slice(-1*e.length)===e}function isLine(t){if(0===t.childNodes.length)return!1;let e=computeStyle(t);return["block","list-item"].indexOf(e.display)>-1}function traverse(t,e,n){return t.nodeType===t.TEXT_NODE?n.reduce(function(e,n){return n(t,e)},new Delta):t.nodeType===t.ELEMENT_NODE?[].reduce.call(t.childNodes||[],(i,r)=>{let l=traverse(r,e,n);return r.nodeType===t.ELEMENT_NODE&&(l=e.reduce(function(t,e){return e(r,t)},l),l=(r[DOM_KEY]||[]).reduce(function(t,e){return e(r,t)},l)),i.concat(l)},new Delta):new Delta}function matchAlias(t,e,n){return applyFormat(n,t,!0)}function matchAttributor(t,e){let n=Parchment.Attributor.Attribute.keys(t),i=Parchment.Attributor.Class.keys(t),r=Parchment.Attributor.Style.keys(t),l={};return n.concat(i).concat(r).forEach(e=>{let n=Parchment.query(e,Parchment.Scope.ATTRIBUTE);null!=n&&(l[n.attrName]=n.value(t),l[n.attrName])||(null==(n=ATTRIBUTE_ATTRIBUTORS[e])||n.attrName!==e&&n.keyName!==e||(l[n.attrName]=n.value(t)||void 0),null==(n=STYLE_ATTRIBUTORS[e])||n.attrName!==e&&n.keyName!==e||(n=STYLE_ATTRIBUTORS[e],l[n.attrName]=n.value(t)||void 0))}),Object.keys(l).length>0&&(e=applyFormat(e,l)),e}function matchBlot(t,e){let n=Parchment.query(t);if(null==n)return e;if(n.prototype instanceof Parchment.Embed){let i={},r=n.value(t);null!=r&&(i[n.blotName]=r,e=(new Delta).insert(i,n.formats(t)))}else"function"==typeof n.formats&&(e=applyFormat(e,n.blotName,n.formats(t)));return e}function matchBreak(t,e){return deltaEndsWith(e,"\n")||e.insert("\n"),e}function matchIgnore(){return new Delta}function matchIndent(t,e){let n=Parchment.query(t);if(null==n||"list-item"!==n.blotName||!deltaEndsWith(e,"\n"))return e;let i=-1,r=t.parentNode;for(;!r.classList.contains("ql-clipboard");)"list"===(Parchment.query(r)||{}).blotName&&(i+=1),r=r.parentNode;return i<=0?e:e.compose((new Delta).retain(e.length()-1).retain(1,{indent:i}))}function matchNewline(t,e){return deltaEndsWith(e,"\n")||(isLine(t)||e.length()>0&&t.nextSibling&&isLine(t.nextSibling))&&e.insert("\n"),e}function matchSpacing(t,e){if(isLine(t)&&null!=t.nextElementSibling&&!deltaEndsWith(e,"\n\n")){let n=t.offsetHeight+parseFloat(computeStyle(t).marginTop)+parseFloat(computeStyle(t).marginBottom);t.nextElementSibling.offsetTop>t.offsetTop+1.5*n&&e.insert("\n")}return e}function matchStyles(t,e){let n={},i=t.style||{};return i.fontStyle&&"italic"===computeStyle(t).fontStyle&&(n.italic=!0),i.fontWeight&&(computeStyle(t).fontWeight.startsWith("bold")||parseInt(computeStyle(t).fontWeight)>=700)&&(n.bold=!0),Object.keys(n).length>0&&(e=applyFormat(e,n)),parseFloat(i.textIndent||0)>0&&(e=(new Delta).insert("\t").concat(e)),e}function matchText(t,e){let n=t.data;if("O:P"===t.parentNode.tagName)return e.insert(n.trim());if(0===n.trim().length&&t.parentNode.classList.contains("ql-clipboard"))return e;if(!computeStyle(t.parentNode).whiteSpace.startsWith("pre")){let e=function(t,e){return(e=e.replace(/[^\u00a0]/g,"")).length<1&&t?" ":e};n=(n=n.replace(/\r\n/g," ").replace(/\n/g," ")).replace(/\s\s+/g,e.bind(e,!0)),(null==t.previousSibling&&isLine(t.parentNode)||null!=t.previousSibling&&isLine(t.previousSibling))&&(n=n.replace(/^\s+/,e.bind(e,!1))),(null==t.nextSibling&&isLine(t.parentNode)||null!=t.nextSibling&&isLine(t.nextSibling))&&(n=n.replace(/\s+$/,e.bind(e,!1)))}return e.insert(n)}Clipboard.DEFAULTS={matchers:[],matchVisual:!0};export{Clipboard as default,matchAttributor,matchBlot,matchNewline,matchSpacing,matchText};
//# sourceMappingURL=/sm/e6e401f140df1df46a24e0707c7fb0ec45cc63b6854a4b89ae50af410e7ef0d3.map