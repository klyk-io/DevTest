/**
 * Minified by jsDelivr using Terser v3.14.1.
 * Original file: /npm/quill@1.3.7/core/selection.js
 * 
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import Parchment from"parchment";import clone from"clone";import equal from"deep-equal";import Emitter from"./emitter";import logger from"./logger";let debug=logger("quill:selection");class Range{constructor(t,e=0){this.index=t,this.length=e}}class Selection{constructor(t,e){this.emitter=e,this.scroll=t,this.composing=!1,this.mouseDown=!1,this.root=this.scroll.domNode,this.cursor=Parchment.create("cursor",this),this.lastRange=this.savedRange=new Range(0,0),this.handleComposition(),this.handleDragging(),this.emitter.listenDOM("selectionchange",document,()=>{this.mouseDown||setTimeout(this.update.bind(this,Emitter.sources.USER),1)}),this.emitter.on(Emitter.events.EDITOR_CHANGE,(t,e)=>{t===Emitter.events.TEXT_CHANGE&&e.length()>0&&this.update(Emitter.sources.SILENT)}),this.emitter.on(Emitter.events.SCROLL_BEFORE_UPDATE,()=>{if(!this.hasFocus())return;let t=this.getNativeRange();null!=t&&t.start.node!==this.cursor.textNode&&this.emitter.once(Emitter.events.SCROLL_UPDATE,()=>{try{this.setNativeRange(t.start.node,t.start.offset,t.end.node,t.end.offset)}catch(t){}})}),this.emitter.on(Emitter.events.SCROLL_OPTIMIZE,(t,e)=>{if(e.range){const{startNode:t,startOffset:n,endNode:s,endOffset:i}=e.range;this.setNativeRange(t,n,s,i)}}),this.update(Emitter.sources.SILENT)}handleComposition(){this.root.addEventListener("compositionstart",()=>{this.composing=!0}),this.root.addEventListener("compositionend",()=>{if(this.composing=!1,this.cursor.parent){const t=this.cursor.restore();if(!t)return;setTimeout(()=>{this.setNativeRange(t.startNode,t.startOffset,t.endNode,t.endOffset)},1)}})}handleDragging(){this.emitter.listenDOM("mousedown",document.body,()=>{this.mouseDown=!0}),this.emitter.listenDOM("mouseup",document.body,()=>{this.mouseDown=!1,this.update(Emitter.sources.USER)})}focus(){this.hasFocus()||(this.root.focus(),this.setRange(this.savedRange))}format(t,e){if(null!=this.scroll.whitelist&&!this.scroll.whitelist[t])return;this.scroll.update();let n=this.getNativeRange();if(null!=n&&n.native.collapsed&&!Parchment.query(t,Parchment.Scope.BLOCK)){if(n.start.node!==this.cursor.textNode){let t=Parchment.find(n.start.node,!1);if(null==t)return;if(t instanceof Parchment.Leaf){let e=t.split(n.start.offset);t.parent.insertBefore(this.cursor,e)}else t.insertBefore(this.cursor,n.start.node);this.cursor.attach()}this.cursor.format(t,e),this.scroll.optimize(),this.setNativeRange(this.cursor.textNode,this.cursor.textNode.data.length),this.update()}}getBounds(t,e=0){let n=this.scroll.length();t=Math.min(t,n-1),e=Math.min(t+e,n-1)-t;let s,[i,o]=this.scroll.leaf(t);if(null==i)return null;[s,o]=i.position(o,!0);let r=document.createRange();if(e>0)return r.setStart(s,o),[i,o]=this.scroll.leaf(t+e),null==i?null:([s,o]=i.position(o,!0),r.setEnd(s,o),r.getBoundingClientRect());{let t,e="left";return s instanceof Text?(o<s.data.length?(r.setStart(s,o),r.setEnd(s,o+1)):(r.setStart(s,o-1),r.setEnd(s,o),e="right"),t=r.getBoundingClientRect()):(t=i.domNode.getBoundingClientRect(),o>0&&(e="right")),{bottom:t.top+t.height,height:t.height,left:t[e],right:t[e],top:t.top,width:0}}}getNativeRange(){let t=document.getSelection();if(null==t||t.rangeCount<=0)return null;let e=t.getRangeAt(0);if(null==e)return null;let n=this.normalizeNative(e);return debug.info("getNativeRange",n),n}getRange(){let t=this.getNativeRange();return null==t?[null,null]:[this.normalizedToRange(t),t]}hasFocus(){return document.activeElement===this.root}normalizedToRange(t){let e=[[t.start.node,t.start.offset]];t.native.collapsed||e.push([t.end.node,t.end.offset]);let n=e.map(t=>{let[e,n]=t,s=Parchment.find(e,!0),i=s.offset(this.scroll);return 0===n?i:s instanceof Parchment.Container?i+s.length():i+s.index(e,n)}),s=Math.min(Math.max(...n),this.scroll.length()-1),i=Math.min(s,...n);return new Range(i,s-i)}normalizeNative(t){if(!contains(this.root,t.startContainer)||!t.collapsed&&!contains(this.root,t.endContainer))return null;let e={start:{node:t.startContainer,offset:t.startOffset},end:{node:t.endContainer,offset:t.endOffset},native:t};return[e.start,e.end].forEach(function(t){let e=t.node,n=t.offset;for(;!(e instanceof Text)&&e.childNodes.length>0;)if(e.childNodes.length>n)e=e.childNodes[n],n=0;else{if(e.childNodes.length!==n)break;n=(e=e.lastChild)instanceof Text?e.data.length:e.childNodes.length+1}t.node=e,t.offset=n}),e}rangeToNative(t){let e=t.collapsed?[t.index]:[t.index,t.index+t.length],n=[],s=this.scroll.length();return e.forEach((t,e)=>{t=Math.min(s-1,t);let i,[o,r]=this.scroll.leaf(t);[i,r]=o.position(r,0!==e),n.push(i,r)}),n.length<2&&(n=n.concat(n)),n}scrollIntoView(t){let e=this.lastRange;if(null==e)return;let n=this.getBounds(e.index,e.length);if(null==n)return;let s=this.scroll.length()-1,[i]=this.scroll.line(Math.min(e.index,s)),o=i;if(e.length>0&&([o]=this.scroll.line(Math.min(e.index+e.length,s))),null==i||null==o)return;let r=t.getBoundingClientRect();n.top<r.top?t.scrollTop-=r.top-n.top:n.bottom>r.bottom&&(t.scrollTop+=n.bottom-r.bottom)}setNativeRange(t,e,n=t,s=e,i=!1){if(debug.info("setNativeRange",t,e,n,s),null!=t&&(null==this.root.parentNode||null==t.parentNode||null==n.parentNode))return;let o=document.getSelection();if(null!=o)if(null!=t){this.hasFocus()||this.root.focus();let r=(this.getNativeRange()||{}).native;if(null==r||i||t!==r.startContainer||e!==r.startOffset||n!==r.endContainer||s!==r.endOffset){"BR"==t.tagName&&(e=[].indexOf.call(t.parentNode.childNodes,t),t=t.parentNode),"BR"==n.tagName&&(s=[].indexOf.call(n.parentNode.childNodes,n),n=n.parentNode);let i=document.createRange();i.setStart(t,e),i.setEnd(n,s),o.removeAllRanges(),o.addRange(i)}}else o.removeAllRanges(),this.root.blur(),document.body.focus()}setRange(t,e=!1,n=Emitter.sources.API){if("string"==typeof e&&(n=e,e=!1),debug.info("setRange",t),null!=t){let n=this.rangeToNative(t);this.setNativeRange(...n,e)}else this.setNativeRange(null);this.update(n)}update(t=Emitter.sources.USER){let e=this.lastRange,[n,s]=this.getRange();if(this.lastRange=n,null!=this.lastRange&&(this.savedRange=this.lastRange),!equal(e,this.lastRange)){!this.composing&&null!=s&&s.native.collapsed&&s.start.node!==this.cursor.textNode&&this.cursor.restore();let n=[Emitter.events.SELECTION_CHANGE,clone(this.lastRange),clone(e),t];this.emitter.emit(Emitter.events.EDITOR_CHANGE,...n),t!==Emitter.sources.SILENT&&this.emitter.emit(...n)}}}function contains(t,e){try{e.parentNode}catch(t){return!1}return e instanceof Text&&(e=e.parentNode),t.contains(e)}export{Range,Selection as default};
//# sourceMappingURL=/sm/417a51dcfba62571b518fe0d71ec3928ed3a0d519a2ac60e159d828f6783926f.map